<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>iOS 远程打包脚本制作 - Haisheng Wu's Tech Blog</title><meta name=description content="This is Haisheng Wu's Tech Blog"><meta property="og:title" content="iOS 远程打包脚本制作"><meta property="og:description" content="在 iOS 开发中，一般打发布包都是在本地打包，也就是工程师在自己开发电脑上使用 Xcode 编译并导出安装包来进行发布，为了提高效率可能会制作一些自动化打包脚本。本文聊的是远程打包的内容，通过资源拷贝及参数替换然后编译完成打包。
由于 HTML5 跨平台的特点，很多技术团队考虑到代码复用，在部分模块中会采用 h5 来描述界面。甚至有些不需要太复杂交互的 app，全部界面采用 h5 来编写，也就是一个 web 工程。对于大部分现有的 web 工程，能打包成 app 就已经满足了业务诉求。DCloud 团队开发的 HBuilder（IDE）工具中提供了云打包的功能，用起来很方便，简单的说，就是把 web 工程上传到云打包服务器，最后打包生成 app，点击下载即可安装使用。
虽然云打包服务很方便，但上传源码总感觉不太妥当，总有些秘密不想让别人看见，并且其他同事也有打包的需求，但不一定会使用 HBuilder。因此，搭建一个自己的打包服务很有必要。
按照 HBuilder 提供的云打包功能，先定一个初步的需求：
 支持修改应用 id、版本号 、icon、启动图 支持导入签名文件  开工！！！
准备工作 首先，需要一台安装了 MacOS 的电脑（当做服务器使用）。
笔者手头上刚好有台闲置的电脑就拿来当服务器使用了，装了 WMWare，然后装了 MacOS 虚拟机（问题较多，不建议使用虚拟机）。
 物理机 windows7，内存 4G；虚拟机 MacOS，内存 3G。
 其次，在服务器上部署一个 web 服务，提供打包交互界面方便客户端上传资源文件及下载安装包。我们的界面只提供了一个 www zip 包的上传入口，所有应用资源及打包相关的配置文件都在里面。www 目录结构如下：
appConfig.json 文件内容 1 2 3 4 5 6 7 8 9 10 11  { &#34;id&#34;:&#34;com."><meta property="og:type" content="article"><meta property="og:url" content="http://www.redscarf.me/ios-remote-pack/"><meta property="og:image" content="http://www.redscarf.me/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-23T20:00:50+10:00"><meta property="article:modified_time" content="2018-07-23T20:00:50+10:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://www.redscarf.me/logo.png"><meta name=twitter:title content="iOS 远程打包脚本制作"><meta name=twitter:description content="在 iOS 开发中，一般打发布包都是在本地打包，也就是工程师在自己开发电脑上使用 Xcode 编译并导出安装包来进行发布，为了提高效率可能会制作一些自动化打包脚本。本文聊的是远程打包的内容，通过资源拷贝及参数替换然后编译完成打包。
由于 HTML5 跨平台的特点，很多技术团队考虑到代码复用，在部分模块中会采用 h5 来描述界面。甚至有些不需要太复杂交互的 app，全部界面采用 h5 来编写，也就是一个 web 工程。对于大部分现有的 web 工程，能打包成 app 就已经满足了业务诉求。DCloud 团队开发的 HBuilder（IDE）工具中提供了云打包的功能，用起来很方便，简单的说，就是把 web 工程上传到云打包服务器，最后打包生成 app，点击下载即可安装使用。
虽然云打包服务很方便，但上传源码总感觉不太妥当，总有些秘密不想让别人看见，并且其他同事也有打包的需求，但不一定会使用 HBuilder。因此，搭建一个自己的打包服务很有必要。
按照 HBuilder 提供的云打包功能，先定一个初步的需求：
 支持修改应用 id、版本号 、icon、启动图 支持导入签名文件  开工！！！
准备工作 首先，需要一台安装了 MacOS 的电脑（当做服务器使用）。
笔者手头上刚好有台闲置的电脑就拿来当服务器使用了，装了 WMWare，然后装了 MacOS 虚拟机（问题较多，不建议使用虚拟机）。
 物理机 windows7，内存 4G；虚拟机 MacOS，内存 3G。
 其次，在服务器上部署一个 web 服务，提供打包交互界面方便客户端上传资源文件及下载安装包。我们的界面只提供了一个 www zip 包的上传入口，所有应用资源及打包相关的配置文件都在里面。www 目录结构如下：
appConfig.json 文件内容 1 2 3 4 5 6 7 8 9 10 11  { &#34;id&#34;:&#34;com."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://www.redscarf.me/ios-remote-pack/><link rel=prev href=http://www.redscarf.me/android-gradle-build/><link rel=next href=http://www.redscarf.me/ios-wvjb-sc-analyse/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"iOS 远程打包脚本制作","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/www.redscarf.me\/ios-remote-pack\/"},"genre":"posts","keywords":"iOS, Python","wordcount":2089,"url":"http:\/\/www.redscarf.me\/ios-remote-pack\/","datePublished":"2018-07-23T20:00:50+10:00","dateModified":"2018-07-23T20:00:50+10:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Haisheng Wu"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Haisheng Wu's Tech Blog"></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>Home </a><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About Me </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Haisheng Wu's Tech Blog"></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title>Home</a><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About Me</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">iOS 远程打包脚本制作</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>Haisheng Wu</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/ios/><i class="far fa-folder fa-fw"></i>iOS</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2018-07-23>2018-07-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2089 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a><ul><li><a href=#appconfigjson-文件内容>appConfig.json 文件内容</a></li><li><a href=#secretjson-文件内容>secret.json 文件内容</a></li></ul></li><li><a href=#python-打包脚本>Python 打包脚本</a><ul><li><a href=#下载-ios-工程代码到指定目录>下载 iOS 工程代码到指定目录</a></li><li><a href=#将客户端上传的-www-文件资源拷贝到-ios-工程目录>将客户端上传的 www 文件资源拷贝到 iOS 工程目录</a></li><li><a href=#修改-ios-工程配置>修改 iOS 工程配置</a></li><li><a href=#导入证书到系统钥匙串>导入证书到系统钥匙串</a></li><li><a href=#导入-mobileprovision-文件>导入 mobileprovision 文件</a></li><li><a href=#编译工程>编译工程</a></li><li><a href=#导出-ipa-安装包>导出 ipa 安装包</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>在 iOS 开发中，一般打发布包都是在本地打包，也就是工程师在自己开发电脑上使用 Xcode 编译并导出安装包来进行发布，为了提高效率可能会制作一些自动化打包脚本。本文聊的是远程打包的内容，通过资源拷贝及参数替换然后编译完成打包。</p><p>由于 HTML5 跨平台的特点，很多技术团队考虑到代码复用，在部分模块中会采用 h5 来描述界面。甚至有些不需要太复杂交互的 app，全部界面采用 h5 来编写，也就是一个 web 工程。对于大部分现有的 web 工程，能打包成 app 就已经满足了业务诉求。DCloud 团队开发的 HBuilder（IDE）工具中提供了云打包的功能，用起来很方便，简单的说，就是把 web 工程上传到云打包服务器，最后打包生成 app，点击下载即可安装使用。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297147/web/dcloud-pack-param_atnmdu.png data-srcset="https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297147/web/dcloud-pack-param_atnmdu.png, https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297147/web/dcloud-pack-param_atnmdu.png 1.5x, https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297147/web/dcloud-pack-param_atnmdu.png 2x" data-sizes=auto alt=https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297147/web/dcloud-pack-param_atnmdu.png title=dcloud-pack-param></p><p>虽然云打包服务很方便，但上传源码总感觉不太妥当，总有些秘密不想让别人看见，并且其他同事也有打包的需求，但不一定会使用 HBuilder。因此，搭建一个自己的打包服务很有必要。</p><p>按照 HBuilder 提供的云打包功能，先定一个初步的需求：</p><ul><li>支持修改应用 id、版本号 、icon、启动图</li><li>支持导入签名文件</li></ul><p>开工！！！</p><h2 id=准备工作>准备工作</h2><p>首先，需要一台安装了 MacOS 的电脑（当做服务器使用）。</p><p>笔者手头上刚好有台闲置的电脑就拿来当服务器使用了，装了 WMWare，然后装了 MacOS 虚拟机（问题较多，不建议使用虚拟机）。</p><blockquote><p>物理机 windows7，内存 4G；虚拟机 MacOS，内存 3G。</p></blockquote><p>其次，在服务器上部署一个 web 服务，提供打包交互界面方便客户端上传资源文件及下载安装包。我们的界面只提供了一个 <code>www</code> zip 包的上传入口，所有应用资源及打包相关的配置文件都在里面。www 目录结构如下：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297146/web/paf-www-dir_aabjio.png data-srcset="https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297146/web/paf-www-dir_aabjio.png, https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297146/web/paf-www-dir_aabjio.png 1.5x, https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297146/web/paf-www-dir_aabjio.png 2x" data-sizes=auto alt=https://res.cloudinary.com/dtbpgyfsc/image/upload/v1625297146/web/paf-www-dir_aabjio.png title=paf-www-dir></p><h3 id=appconfigjson-文件内容>appConfig.json 文件内容</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
	&#34;id&#34;:&#34;com.domain.pack&#34;,
	&#34;appName&#34;:&#34;我的应用&#34;,
	&#34;debug&#34;:true,
	&#34;launchPath&#34;: &#34;index.html&#34;,
	&#34;version&#34;: {
		&#34;name&#34;: &#34;1.0.0&#34;,
		&#34;code&#34;: &#34;100&#34;
	},
	...
}
</code></pre></td></tr></table></div></div><p><code>launchPath</code> 对应 web 应用入口文件，iOS 工程使用这个文件路径作为 webview 的加载入口。</p><h3 id=secretjson-文件内容>secret.json 文件内容</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
	&#34;ios&#34; : {
		&#34;p12Password&#34; : &#34;123456&#34;
	},
	&#34;android&#34; : {
		&#34;keyAlias&#34; : &#34;keyAlias&#34;,
		&#34;keyPassword&#34; : &#34;123456&#34;,
		&#34;storePassword&#34; : &#34;123456&#34;,
		&#34;amapApiKey&#34; : &#34;&#34;,
		&#34;jpushApiKey&#34; : &#34;&#34;,
		...
	}
}
</code></pre></td></tr></table></div></div><p>除了交互界面外，打包服务还需要提供调起 Python 脚本的功能。</p><h2 id=python-打包脚本>Python 打包脚本</h2><p>基本所有的功能都使用脚本实现，使用 Python 编写打包脚本是因为 Python 用起来方便，刚开始打算用 Shell 来编写，执行效果可能好一些，但是对这个不熟，只好将就用 Python。我们的 web 服务采用 Java 编写，Java 是可以调用 Python 脚本的 <code>ProcessBuilder pb = new ProcessBuilder(command.split(" ")); </code>。打包脚本事先准备好，放在 web 服务站点根目录下，在解压完 <code>www</code> zip 包之后，把脚本拷贝到与 www 目录同级目录中，然后执行脚本打包。打包脚本主要做以下几件事情：</p><ul><li>下载 iOS 工程代码到指定目录</li><li>将客户端上传的 www 文件资源拷贝到 iOS 工程目录，应用图标、启动图等</li><li>修改 iOS 工程配置</li><li>导入证书到系统钥匙串</li><li>导入 mobileprovision 文件</li><li>编译工程</li><li>导出 ipa 安装包</li></ul><blockquote><p>打包脚本和客户端上传的 www 文件夹需要放在同一目录下。</p></blockquote><p>实现难度不是很大，但是细节很多，需要反复实践尝试。脚本全部内容见文章末尾。</p><h3 id=下载-ios-工程代码到指定目录>下载 iOS 工程代码到指定目录</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>svnChekoutCmd = &#39;svn co --username=%s --password=%s %s %s&#39; %(SVN_USERNAME, SVN_PASSWORD, SVN_URL, checkoutPath())
p = subprocess.Popen(svnChekoutCmd, shell=True, stderr=subprocess.PIPE)
p.wait()
</code></pre></td></tr></table></div></div><p>从 svn 仓库拉取 iOS 工程代码，使用 <code>svn checkout</code> 命令把代码拷贝到指定目录，后面会使用这个目录下的工程进行编译。</p><h3 id=将客户端上传的-www-文件资源拷贝到-ios-工程目录>将客户端上传的 www 文件资源拷贝到 iOS 工程目录</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>sourceWWWDir = currentDir() + &#39;/www&#39;
projectWWWDir = &#39;/packProject/www&#39;
destinationWWWDir = checkoutPath() + projectWWWDir
copyFiles(sourceWWWDir, destinationWWWDir)
for file in os.listdir(destinationWWWDir):
    if file.startswith(&#39;secret.json&#39;) or file.endswith(&#39;.mobileprovision&#39;) or file.endswith(&#39;.p12&#39;):
        os.remove(destinationWWWDir + &#39;/&#39; + file)
</code></pre></td></tr></table></div></div><p>将客户端上传的 <code>www</code> 文件夹拷贝到 iOS 工程中的 www 目录下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>iconAssetDirectory = checkoutPath() + &#39;/packProject/Assets.xcassets/AppIcon.appiconset&#39;
iconSrcDirectory = projectWWWDir + &#39;/Icons/ios&#39;
items = os.listdir(iconSrcDirectory)
for filename in items:
    copyFile(iconSrcDirectory + &#39;/&#39; + filename, iconAssetDirectory + &#39;/&#39; + filename)
clearDir(iconSrcDirectory)
</code></pre></td></tr></table></div></div><p>将 <code>www/Icons/ios</code> 文件夹中的各种尺寸的应用图标拷贝到 <code>Assets.xcassets/AppIcon.appiconset</code> 目录中。这个需要事先编写好 <code>AppIcon.appiconset</code> 中的 <code>Contents.json</code> 文件，为每种尺寸的 icon 指定文件名，这里的文件名与 <code>Icons/ios</code> 目录下的图片文件名一一对应，所以，<code>Icons/ios</code> 中的图片名称是固定不变的。<code>Contents.json</code> 文件部分内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
  &#34;images&#34; : [
    {
      &#34;idiom&#34; : &#34;iphone&#34;,
      &#34;size&#34; : &#34;20x20&#34;,
      &#34;filename&#34; : &#34;40x40.png&#34;,
      &#34;scale&#34; : &#34;2x&#34;
    },
    {
      &#34;idiom&#34; : &#34;iphone&#34;,
      &#34;size&#34; : &#34;20x20&#34;,
      &#34;filename&#34; : &#34;60x60.png&#34;,
      &#34;scale&#34; : &#34;3x&#34;
    },
    {
      &#34;idiom&#34; : &#34;iphone&#34;,
      &#34;size&#34; : &#34;29x29&#34;,
      &#34;filename&#34; : &#34;58x58.png&#34;,
      &#34;scale&#34; : &#34;2x&#34;
    },
    {
      &#34;idiom&#34; : &#34;iphone&#34;,
      &#34;size&#34; : &#34;29x29&#34;,
      &#34;filename&#34; : &#34;87x87.png&#34;,
      &#34;scale&#34; : &#34;3x&#34;
    },
    {
      &#34;idiom&#34; : &#34;iphone&#34;,
      &#34;size&#34; : &#34;40x40&#34;,
      &#34;filename&#34; : &#34;80x80.png&#34;,
      &#34;scale&#34; : &#34;2x&#34;
    },
}
</code></pre></td></tr></table></div></div><p>启动图资源的拷贝跟应用图标的拷贝一样，需要事先编写好 <code>Contents.json</code> 文件，并且启动图的名称也是固定的。</p><h3 id=修改-ios-工程配置>修改 iOS 工程配置</h3><p>需要根据客户端上传的配置文件 <code>appConfig.json</code> 来修改工程配置。</p><p>首先，读取配置文件的内容，包括应用 id 、名称、版本号、编译号、应用入口等。Python 读取 json 文件字符串类型的值默认会转为 unicode 编码表示，需要进行处理，笔者专门写了一个 <code>json_load_byteified</code> 函数来处理这个问题。</p><p>其次，使用从配置文件中获取到的内容来修改 <code>info.plist</code> 文件。这里需要使用 MacOS 系统自带的工具 <code>PlistBuddy</code> 来辅助修改。</p><h3 id=导入证书到系统钥匙串>导入证书到系统钥匙串</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>p12FilePath = findFileInDirectory(&#39;.p12&#39;, sourceWWWDir)
unlockKeychainCmd = &#39;security unlock-keychain -p %s&#39; %MacOS_ADMIN_PASSWORD
p = subprocess.Popen(unlockKeychainCmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
p.wait()
if p.returncode != 0:
    print p.stderr.read()
    return
importCertCmd = &#39;security import %s -P %s -T /usr/bin/codesign&#39; % (p12FilePath, p12Password)
p = subprocess.Popen(importCertCmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
p.wait()
if p.returncode != 0:
    print p.stderr.read()
</code></pre></td></tr></table></div></div><p>使用系统 <code>security</code> 工具将 p12 文件导入到系统钥匙串中，先打开系统钥匙串并提供系统管理员密码，然后再导入。</p><blockquote><p>证书和私钥需要客户端事先准备好，并导出为 p12 文件一并放入 www 文件夹中上传（如何导出 p12 文件请自行查看官方文档）。p12 文件的密码规定写在 <code>secret.json</code> 文件中。</p></blockquote><h3 id=导入-mobileprovision-文件>导入 mobileprovision 文件</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>provisionFileExtension = &#39;.mobileprovision&#39;
provisionFilePath = findFileInDirectory(provisionFileExtension, sourceWWWDir)
if not len(provisionFilePath) &gt; 0:
    print (&#34;[packageFailed]: Not found \&#39;%s\&#39; file in \&#39;www\&#39; directory.&#34;) %(provisionFileExtension)
    return
teamIdentifier = getMobileProvisionItem(provisionFilePath, &#39;TeamIdentifier&#39;)
provisionUUID = getMobileProvisionItem(provisionFilePath, &#39;UUID&#39;)
provisionName = getMobileProvisionItem(provisionFilePath, &#39;Name&#39;)
# type – prints mobileprovision profile type (debug, ad-hoc, enterprise, appstore)
provisionType = getMobileProvisionItem(provisionFilePath, &#39;type&#39;)
teamName = getMobileProvisionItem(provisionFilePath, &#39;TeamName&#39;)
desProvisionFilePath = PROVISONING_PROFILE_DIRECTORY + provisionUUID + provisionFileExtension
copyFile(provisionFilePath, desProvisionFilePath)
</code></pre></td></tr></table></div></div><p>读取 <code>.mobileprovision</code> 文件的信息，并将 uuid 作为它的文件名保存到 <code>/Users/%s/Library/MobileDevice/Provisioning Profiles/</code> 目录，完成导入。如果先前已经导入过该类文件（一般双击文件导入），打开这个目录可以看到，文件名都是 uuid。这里，除了 uuid 之外，还可以读取团队 id、名称以及文件类型（debug, ad-hoc, enterprise, appstore）等信息。</p><p>为了方便读取 <code>.mobileprovision</code> 文件信息，这里使用一个第三方命令行小工具。安装命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>curl https://raw.githubusercontent.com/0xc010d/mobileprovision-read/master/main.m | clang -framework Foundation -framework Security -o /usr/local/bin/mobileprovision-read -x objective-c - 
</code></pre></td></tr></table></div></div><p>安装命令会使用 curl 工具下载源码，然后使用 clang 编译并将可执行文件输出到 <code>/usr/local/bin/</code> 目录，命名为 <code>mobileprovision-read</code>，用法：</p><p><code>mobileprovision-read -f fileName [-o option]</code></p><p>该工具实现比较简单，使用 <code>security</code> 库解析 <code>mobileprovision</code> 文件，然后根据命令行输入的 option 选择输出结果，因为笔者没有对源码进行修改，所以需要对输出结果中的控制字符 <code>\n</code> 进行处理（<code>removeControlChars</code> 函数的作用）。</p><h3 id=编译工程>编译工程</h3><p>编译源码。以前在苹果线上开发者文档可以查看 <code>xcodebuild</code> 用法，不知道什么时候删掉了，现在只能使用 <code>man xcodebuild</code> 查看 <code>xcodebuild</code> 用法，这个不多说。需要注意的是，刚才只是导入了 <code>.mobileprovision</code> 文件，工程配置并没有修改，所以没有关联起来。在 <code>project.pbxproj</code> 文件中有以下几个字段需要进行替换，替换完之后才算完成整个工程编译变量的配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>PRODUCT_BUNDLE_IDENTIFIER
PROVISIONING_PROFILE_SPECIFIER
PROVISIONING_PROFILE
</code></pre></td></tr></table></div></div><p>可以在命令行传入这几个编译变量完成替换，命令行中传入的编译变量优先级最高。</p><p><em><code>project.pbxproj</code> 不是常见的文件格式，在不知道 xcodebuild 可以注入编译变量之前，找了一圈发现没有方便的工具可以用来编辑。有人建议先转成 json 然后再使用 json 编辑工具进行修改。笔者没有采纳，笔者想到用 sed，但 sed 只对简单的文本内容有效，这种嵌套层级太多的内容貌似匹配不了，所以，无法进行修改。awk 应该可以，但这个我没有尝试。</em></p><h3 id=导出-ipa-安装包>导出 ipa 安装包</h3><p>创建 <code>exportOptions.plist</code> 文件并导出 <code>.ipa</code> 安装包。把生成的 <code>.ipa</code> 文件路径输出给 java 进程，java 进程将结果显示在界面上，方便客户端进行下载。</p><blockquote><p>注意：
Python 脚本没有执行权限，需要使用 <a href=https://zh.wikipedia.org/wiki/Chmod target=_blank rel="noopener noreferrer">Chmod</a> 命令添加执行权限。</p></blockquote><p>脚本全部内容如下（详见 <a href=https://github.com/iCocoa/PackScript target=_blank rel="noopener noreferrer">github 源码</a>）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>#!/usr/bin/env python
# _*_ coding:utf-8 _*_

import subprocess
import os
import json
import re

SVN_USERNAME = &#39;Hansen&#39;
SVN_PASSWORD = &#39;123456&#39;
SVN_URL = &#39;https://Hansen@svn.domain.com/svn/****/trunk/iOS/packProject&#39;
CHECKOUT_FOLDER = &#39;ios_source_code&#39;
MacOS_ADMIN_USER = &#39;packrobot&#39;
MacOS_ADMIN_PASSWORD = &#39;123456&#39;
EXPORT_MAIN_DIRECTORY = &#34;/Users/%s/Documents/ios_appArchive/&#34; % MacOS_ADMIN_USER
PROVISONING_PROFILE_DIRECTORY = &#34;/Users/%s/Library/MobileDevice/Provisioning Profiles/&#34; % MacOS_ADMIN_USER

def json_load_byteified(file_handle):
    return _byteify(
        json.load(file_handle, object_hook=_byteify),
        ignore_dicts=True
    )

def json_loads_byteified(json_text):
    return _byteify(
        json.loads(json_text, object_hook=_byteify),
        ignore_dicts=True
    )

def _byteify(data, ignore_dicts = False):
    # if this is a unicode string, return its string representation
    if isinstance(data, unicode):
        return data.encode(&#39;utf-8&#39;)
    # if this is a list of values, return list of byteified values
    if isinstance(data, list):
        return [ _byteify(item, ignore_dicts=True) for item in data ]
    # if this is a dictionary, return dictionary of byteified keys and values
    # but only if we haven&#39;t already byteified it
    if isinstance(data, dict) and not ignore_dicts:
        return {
            _byteify(key, ignore_dicts=True): _byteify(value, ignore_dicts=True)
            for key, value in data.iteritems()
        }
    # if it&#39;s anything else, return it in its original form
    return data

def currentDir():
    return os.path.split(os.path.realpath(__file__))[0]

def checkoutPath():
    return currentDir() + &#39;/&#39; + CHECKOUT_FOLDER

def pullSvnSourceCode():
    svnChekoutCmd = &#39;svn co --username=%s --password=%s %s %s&#39; %(SVN_USERNAME, SVN_PASSWORD, SVN_URL, checkoutPath())
    p = subprocess.Popen(svnChekoutCmd, shell=True, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print (&#39;[packageFailed]: %s&#39;) %p.stderr.read()
    else:
        print (&#39;Sucessfullly checkout source code at path: %s&#39;) %(checkoutPath())

def clearDir(Dir):
    cleanCmd = &#34;rm -r %s&#34; %(Dir)
    process = subprocess.Popen(cleanCmd, shell=True)
    (stdoutdata, stderrdata) = process.communicate()

def getAppConfig():
    projectWWWDir = &#39;packProject/www&#39;
    destinationWWWDir = currentDir() + &#39;/&#39; + CHECKOUT_FOLDER + &#39;/&#39; + projectWWWDir;
    appConfigFilePath = destinationWWWDir + &#39;/appConfig.json&#39;
    if os.path.exists(appConfigFilePath):
        appConfigReader = open(appConfigFilePath, &#39;r&#39;)
        appConfig = json_load_byteified(appConfigReader)
        appConfigReader.close()
        return appConfig
    return None


def copyFiles(sourceDir, destinationDir):
    if not os.path.exists(sourceDir):
        print (&#39;[packageFailed]: Copy file -- sourceDir doesn\&#39;t exist &#39;)
        pass

    clearDir(destinationDir)
    for file in os.listdir(sourceDir):
        sourceFile = os.path.join(sourceDir, file)
        destinationFile = os.path.join(destinationDir, file)
        if os.path.isfile(sourceFile):
            if not os.path.exists(destinationDir):
                os.makedirs(destinationDir)
            if not os.path.exists(destinationFile) or (os.path.exists(destinationFile) and (os.path.getsize(destinationFile) != os.path.getsize(sourceFile))):
                open(destinationFile, &#34;wb&#34;).write(open(sourceFile, &#34;rb&#34;).read())
        if os.path.isdir(sourceFile):
            copyFiles(sourceFile, destinationFile)
    print (&#39;Copy assets success!&#39;)

def copyFile(srcFile, dstFile):
    srcReader = open(srcFile, &#34;rb&#34;)
    desWriter = open(dstFile, &#34;wb&#34;)
    desWriter.write(srcReader.read())
    srcReader.close()
    desWriter.close()

def cleanArchiveFile(archiveFile):
    cleanCmd = &#34;rm -r %s&#34; %(archiveFile)
    process = subprocess.Popen(cleanCmd, shell=True)
    (stdoutdata, stderrdata) = process.communicate()

def buildExportDirectory():
    dateCmd = &#39;date &#34;+%Y-%m-%d_%H-%M-%S&#34;&#39;
    process = subprocess.Popen(dateCmd, stdout=subprocess.PIPE, shell=True)
    (stdoutdata, stderrdata) = process.communicate()
    exportDirectory = &#34;%s%s&#34; %(EXPORT_MAIN_DIRECTORY, stdoutdata.strip())
    return exportDirectory

def getMobileProvisionItem(filepath, key):
    cmd = &#39;mobileprovision-read -f %s -o %s&#39; %(filepath ,key)
    p = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE)
    p.wait()
    return removeControlChars(p.stdout.read())

def updatePlistEntry(filePath, key, value):
    cmd = &#34;/usr/libexec/PlistBuddy -c &#39;Set :%s %s&#39; %s&#34; % (key, value, filePath)
    p = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print p.stderr.read()

def deletePlistEntry(filePath, key):
    cmd = &#34;/usr/libexec/PlistBuddy -c &#39;Delete :%s&#39; %s&#34; %(key, filePath)
    p = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print p.stderr.read()

def addPlistEntry(filePath, key, _type, value):
    cmd = &#34;/usr/libexec/PlistBuddy -c &#39;Add :%s %s %s&#39; %s&#34; % (key, _type, value, filePath)
    p = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print p.stderr.read()

def findFileInDirectory(ext, dir):
    fileName = &#39;&#39;
    items = os.listdir(dir)
    for name in items:
        if name.endswith(ext):
            fileName = name
            break
    if not len(fileName) &gt; 0:
        return &#39;&#39;
    return dir + &#39;/&#39; + fileName

def removeControlChars(s):
    control_chars = &#39;&#39;.join(map(unichr, range(0,32) + range(127,160)))
    control_char_re = re.compile(&#39;[%s]&#39; % re.escape(control_chars))
    return control_char_re.sub(&#39;&#39;, s)

def main():

    # Pull ios project source code from svn.
    pullSvnSourceCode()

    # Copy &#39;www&#39; files. 
    sourceWWWDir = currentDir() + &#39;/www&#39;
    projectWWWDir = &#39;/packProject/www&#39;
    destinationWWWDir = checkoutPath() + projectWWWDir
    copyFiles(sourceWWWDir, destinationWWWDir)
    for file in os.listdir(destinationWWWDir):
        if file.startswith(&#39;secret.json&#39;) or file.endswith(&#39;.mobileprovision&#39;) or file.endswith(&#39;.p12&#39;):
            os.remove(destinationWWWDir + &#39;/&#39; + file)

    # Copy app icons.
    iconAssetDirectory = checkoutPath() + &#39;/packProject/Assets.xcassets/AppIcon.appiconset&#39;
    iconSrcDirectory = projectWWWDir + &#39;/Icons/ios&#39;
    items = os.listdir(iconSrcDirectory)
    for filename in items:
        copyFile(iconSrcDirectory + &#39;/&#39; + filename, iconAssetDirectory + &#39;/&#39; + filename)
    clearDir(iconSrcDirectory)

    # Copy launch images.
    launchImageAssetDirectory = checkoutPath() + &#39;/packProject/Assets.xcassets/LaunchImage.launchimage&#39;
    LaunchImageSrcDirectory = projectWWWDir + &#39;/LaunchImages/ios&#39;
    items = os.listdir(LaunchImageSrcDirectory)
    for filename in items:
        copyFile(LaunchImageSrcDirectory + &#39;/&#39; + filename, launchImageAssetDirectory + &#39;/&#39; + filename)
    clearDir(launchImageAssetDirectory)

    # Read &#39;appConfig.json&#39; file.
    appConfig = getAppConfig()
    if appConfig is None:
        print (&#34;[packageFailed]: Not found \&#39;%s\&#39; file in \&#39;www\&#39; directory.&#34;) % (&#39;appConfig.json&#39;)
        return
    versionName = appConfig[&#39;version&#39;][&#39;name&#39;]
    versionCode = int(appConfig[&#39;version&#39;][&#39;code&#39;])
    applicationId = appConfig[&#39;id&#39;]
    appName = appConfig[&#39;appName&#39;]
    mode = &#39;Debug&#39; if appConfig[&#39;debug&#39;] else &#39;Release&#39;

    # Modify &#39;info.plist&#39; file in project/workspace according to appconfig params those read from &#39;appConfig.json&#39; file.
    infoPlistPath = checkoutPath() + &#39;/packProject/&#39; + &#39;info.plist&#39;
    updatePlistEntry(infoPlistPath, &#39;CFBundleShortVersionString&#39;, versionName)
    updatePlistEntry(infoPlistPath, &#39;CFBundleVersion&#39;, versionCode)
    updatePlistEntry(infoPlistPath, &#39;CFBundleIdentifier&#39;, applicationId)
    updatePlistEntry(infoPlistPath, &#39;CFBundleDisplayName&#39;, appName)

    # Get p12 file&#39;s password.
    secretFilePath = sourceWWWDir + &#39;/secret.json&#39;
    if os.path.exists(secretFilePath):
        secretReader = open(secretFilePath, &#39;r&#39;)
        secretKeyDict = json_load_byteified(secretReader)
        secretReader.close()
    else:
        print (&#34;[packageFailed]: Not found \&#39;%s\&#39; file in \&#39;www\&#39; directory.&#34;) % (&#39;secret.json&#39;)
        return
    iosKeyDict = secretKeyDict[&#39;ios&#39;] if &#39;ios&#39; in secretKeyDict else None
    p12Password = iosKeyDict[&#39;p12Password&#39;] if &#39;p12Password&#39; in iosKeyDict else &#39;123456&#39;

    # Import p12 file into system keychain.
    p12FilePath = findFileInDirectory(&#39;.p12&#39;, sourceWWWDir)
    unlockKeychainCmd = &#39;security unlock-keychain -p %s&#39; %MacOS_ADMIN_PASSWORD
    p = subprocess.Popen(unlockKeychainCmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print p.stderr.read()
        return
    importCertCmd = &#39;security import %s -P %s -T /usr/bin/codesign&#39; % (p12FilePath, p12Password)
    p = subprocess.Popen(importCertCmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print p.stderr.read()

    # Read mobileprovision profile info.
    provisionFileExtension = &#39;.mobileprovision&#39;
    provisionFilePath = findFileInDirectory(provisionFileExtension, sourceWWWDir)
    if not len(provisionFilePath) &gt; 0:
        print (&#34;[packageFailed]: Not found \&#39;%s\&#39; file in \&#39;www\&#39; directory.&#34;) %(provisionFileExtension)
        return
    teamIdentifier = getMobileProvisionItem(provisionFilePath, &#39;TeamIdentifier&#39;) #MNxxxxx8
    provisionUUID = getMobileProvisionItem(provisionFilePath, &#39;UUID&#39;)
    provisionName = getMobileProvisionItem(provisionFilePath, &#39;Name&#39;)
    # type – prints mobileprovision profile type (debug, ad-hoc, enterprise, appstore)
    provisionType = getMobileProvisionItem(provisionFilePath, &#39;type&#39;)
    teamName = getMobileProvisionItem(provisionFilePath, &#39;TeamName&#39;)
    desProvisionFilePath = PROVISONING_PROFILE_DIRECTORY + provisionUUID + provisionFileExtension
    copyFile(provisionFilePath, desProvisionFilePath)

    # Build
    archiveName = &#34;%s_%s.xcarchive&#34; % (applicationId, versionName)
    archiveFilePath = currentDir() + &#39;/&#39; + archiveName
    xcworkspaceFilePath = findFileInDirectory(&#39;.xcworkspace&#39;, checkoutPath())
    projectSettingParams = &#39;PRODUCT_BUNDLE_IDENTIFIER=%s PROVISIONING_PROFILE_SPECIFIER=%s PROVISIONING_PROFILE=%s&#39; %(applicationId, provisionName, provisionUUID)
    archiveCmd = &#39;xcodebuild -workspace %s -scheme %s -configuration %s archive -archivePath %s -destination generic/platform=iOS build %s&#39; % (xcworkspaceFilePath, &#39;packProject&#39;, mode, archiveFilePath, projectSettingParams)
    p = subprocess.Popen(archiveCmd, shell=True, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print (&#34;[packageFailed]: %s&#34;) %p.stderr.read()
        return

    # Create &#39;exportOptions.plist&#39; file and export ipa.
    exportOptionsPlistFilePath = currentDir() + &#39;/&#39; + &#39;exportOptions.plist&#39;
    addPlistEntry(exportOptionsPlistFilePath, &#39;provisioningProfiles&#39;, &#39;dict&#39;, &#39;&#39;)
    addPlistEntry(exportOptionsPlistFilePath, &#39;provisioningProfiles:&#39;+ applicationId, &#39;string&#39;, provisionUUID)
    addPlistEntry(exportOptionsPlistFilePath, &#39;teamID&#39;, &#39;string&#39;, teamIdentifier)
    # {app-store, ad-hoc, enterprise, development}
    method = &#39;development&#39; if cmp(provisionType, &#39;debug&#39;) == 0 else provisionType
    method = &#39;app-store&#39; if cmp(method, &#39;appstore&#39;) == 0 else method
    addPlistEntry(exportOptionsPlistFilePath, &#39;method&#39;, &#39;string&#39;, method)
    exportDirectory = buildExportDirectory()
    exportCmd = &#34;xcodebuild -exportArchive -archivePath %s -exportPath %s -exportOptionsPlist %s&#34; % (archiveFilePath, exportDirectory, exportOptionsPlistFilePath)
    p = subprocess.Popen(exportCmd, shell=True, stderr=subprocess.PIPE)
    p.wait()
    if p.returncode != 0:
        print (&#34;[packageFailed]: %s&#34;) %p.stderr.read()
    else:
        ipaVersion = str(versionCode) if mode == &#39;Debug&#39; else versionName
        ipaName = applicationId + &#39;_&#39; + ipaVersion + &#39;.ipa&#39;
        os.rename(exportDirectory + &#39;/packProject.ipa&#39;, exportDirectory + &#39;/&#39; + ipaName)
        print(&#34;[packageName]: %s&#34;) % (ipaName)
        print(&#34;[packagePath]: %s&#34;) % (exportDirectory)

    cleanArchiveFile(archiveFilePath)

    p = subprocess.Popen(&#39;security lock-keychain&#39;, shell=True)
    p.wait()

if __name__ == &#39;__main__&#39;:
    main()

</code></pre></td></tr></table></div></div><p><em>欢迎留言交流</em></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2018-07-23</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/ios-remote-pack/index.md target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作" data-hashtags=iOS,Python><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://www.redscarf.me/ios-remote-pack/ data-hashtag=iOS><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作"><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=http://www.redscarf.me/ios-remote-pack/ data-title="iOS 远程打包脚本制作"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/ios/>iOS</a>,&nbsp;<a href=/tags/python/>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/android-gradle-build/ class=prev rel=prev title="Android Gradle 注入编译变量"><i class="fas fa-angle-left fa-fw"></i>Android Gradle 注入编译变量</a>
<a href=/ios-wvjb-sc-analyse/ class=next rel=next title="WebViewJavascriptBridge 源码剖析">WebViewJavascriptBridge 源码剖析<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.84.4">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/sunt-programator/CodeIT target=_blank rel="noopener noreferrer" title="CodeIT 0.2.10"><i class="fas fa-laptop-code fa-fw"></i> CodeIT</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Haisheng Wu</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=https://redscarf.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:1e3},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>